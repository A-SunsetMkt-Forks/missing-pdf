\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{missing}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 引入宏包
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage[inner=1.5in,outer=1.25in,vmargin=1in]{geometry}
\RequirePackage{cmbright}
\RequirePackage{fontspec}
\RequirePackage{amsmath,amssymb}
\RequirePackage{graphicx}
\RequirePackage[x11names]{xcolor}
\RequirePackage{wrapfig,tikz,pdfpages}
\RequirePackage{tcolorbox}
\RequirePackage[fontset=none,zihao=false,scheme=chinese,heading=true]{ctex}
\RequirePackage{xeCJKfntef}
\RequirePackage[os=win]{menukeys}
\RequirePackage{pst-barcode}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 格式
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\RequirePackage{hyperref}
\hypersetup{
  colorlinks,%
  linkcolor=red!80!black,%
  bookmarksnumbered=true%
}

% 字体
\setmainfont{Inter}
\setsansfont{Inter}
\setmonofont{等距更纱黑体 Slab SC}

\xeCJKsetup{
  underline/skip  = false,
  AutoFakeSlant   = true
}

\xeCJKDeclareSubCJKBlock{Windows}{"E782 , "EC6A}
\xeCJKDeclareSubCJKBlock{Icons}{"E001 -> "E781, "E782 -> "EC64, "EC6C -> "F8B3}

\setCJKmainfont{思源黑体}[BoldFont=思源黑体 Bold, Windows=Office Support MDL2 Assets, Icons=Segoe Fluent Icons, Mapping=quote]
\setCJKsansfont{思源黑体}[BoldFont=思源黑体 Bold, Windows=Office Support MDL2 Assets, Icons=Segoe Fluent Icons, Mapping=quote]
\setCJKmonofont{等距更纱黑体 Slab SC}

% tcolorbox包
\tcbuselibrary{skins, raster, theorems, breakable}

% menukeys包
\renewmenumacro{\keys}[+]{roundedkeys}

% 页眉页脚
\RequirePackage{fancyhdr}

\fancyhf{}
\fancyhead[OR]{\bfseries\thepage}
\fancyhead[OL]{\bfseries\rightmark}
\fancyhead[ER]{\bfseries\leftmark}
\fancyhead[EL]{\bfseries\thepage}
\renewcommand{\headrulewidth}{0.4pt}

\pagestyle{fancy}

% 目录
\renewcommand\tableofcontents%
  {\renewcommand\thefootnote{\fnsymbol{footnote}}%
    \chapter{\contentsname%
    \protect\@mkboth{\contentsname}{\contentsname}}%
    \@starttoc{toc}%
    \renewcommand\thefootnote{\arabic{footnote}}%
}

% 部分、章节的标题
\newcommand{\partformat}[1]{
  \raggedright
  \tikz[remember picture,overlay] \node at (current page.center) {\includegraphics{assets/missing-parts-bg.pdf}};
  \hspace*{6cm}\parbox[t]{21em}{\vspace*{1.5cm}#1}
}

\newcommand{\partaftername}{
  \CTEXifname{
    \par\vskip10pt{\fontsize{24pt}{24pt}\selectfont\color{DeepSkyBlue3}PART \thepart}\par\vskip20pt
  }{
    \par\vskip10pt{\fontsize{24pt}{24pt}\selectfont\color{DeepSkyBlue3}APPENDIX}\par\vskip20pt
  }
}

\newcommand{\partaftertitle}{%
  \par\vskip22pt%
  {\fontsize{14.2pt}{14pt}\selectfont\color{DeepSkyBlue3}
    YOUR MISSING SEMESTER\par
    \fontsize{17pt}{13pt}\selectfont
    OF USING COMPUTER\par
  }
}

\newcounter{premepi}
\def\premepisymb#1{\expandafter\@premepisymb\csname c@#1\endcsname}
\def\@premepisymb#1{%
  \ifcase#1%
    \or \or %
    \else\@ctrerr
  \fi
}
\renewcommand\thepremepi{\premepisymb{premepi}}

\def\chaptersymb#1{\expandafter\@chaptersymb\csname c@#1\endcsname}
\def\@chaptersymb#1{%
  \ifcase#1%
    \or \or \or \or \or%
    \or \or \or \or \or%
    \or \or \or \or %
    \else\@ctrerr
  \fi
}

\def\appendixsymb#1{\expandafter\@appendixsymb\csname c@#1\endcsname}
\def\@appendixsymb#1{%
  \ifcase#1%
    \or 
    \else\@ctrerr
  \fi
}

\newcommand{\chapterformat}[1]{
  \CTEXifname{
    \bfseries\raggedright
    #1
  }{
    \bfseries\raggedright
    {\Huge\color{DeepSkyBlue3}\noindent\parbox[t][.3ex][b]{6em}{\thepremepi}\par}
    \hspace*{.2cm}#1
  }
}

\newcommand{\chapteraftername}{\hspace*{1cm}
  \renewcommand{\thechapter}{\chaptersymb{chapter}}
  {\Huge\color{DeepSkyBlue3}\parbox[t][.3ex][b]{6em}{\thechapter}\par}
  \renewcommand{\thechapter}{\chinese{chapter}}
  {\fontsize{5pt}{5pt}\color{DeepSkyBlue3}\rule[3pt]{15em}{1.5pt}\par}
}

\let\oldappendix\appendix
\renewcommand{\appendix}{
  \oldappendix%
  \renewcommand{\chapteraftername}{\hspace*{1cm}
    \renewcommand{\thechapter}{\appendixsymb{chapter}}
    {\Huge\color{DeepSkyBlue3}\parbox[t][.3ex][b]{6em}{\thechapter}\par}
    \renewcommand{\thechapter}{\Alph{chapter}}
    {\fontsize{5pt}{5pt}\color{DeepSkyBlue3}\rule[3pt]{13em}{1.5pt}\par}
  }
}

\ctexset{
  part = {
    pagestyle   = empty,
    format      = \partformat,
    nameformat  = \bfseries\fontsize{32pt}{38pt}\selectfont\noindent\color{DeepSkyBlue3},
    aftername   = \partaftername,
    titleformat = \fontsize{64pt}{72pt}\selectfont,
    aftertitle  = \partaftertitle,
  },
  chapter = {
    format      = \chapterformat,
    nameformat  = \huge\noindent\color{DeepSkyBlue3},
    aftername   = \chapteraftername,
    titleformat = \Huge,
    beforeskip  = 18pt,
  },
}

% 列表
\renewcommand{\theenumii}{\Alph{enumii}}

% 禁止随意断词
\hyphenation{macOS}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 空白双数页
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\renewcommand{\cleardoublepage}
  {\clearpage
  \if@twoside
    \ifodd
      \c@page
    \else
      \hbox{}
      \thispagestyle{empty}
      \newpage
      \if@twocolumn
        \hbox{}
        \newpage
      \fi
    \fi
  \fi}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 自定义命令
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 强调文字
\newcommand{\regcolor}[1]{\textbf{{\color{DodgerBlue2} #1}}}

% 标题页
\renewcommand{\maketitle}{%
  \begin{titlepage}
    \pdfbookmark{标题页}{title}
    \thispagestyle{empty}
    \includepdf[pages=1]{assets/missing-cover.pdf}
    \clearpage
    \pdfbookmark{版权信息页}{copyright}
    \setlength{\parskip}{0.3cm}
    \setlength{\parindent}{0em}
    本文档排版于 \@date 。\\
    Git提交编号：\texttt{\input{.git/refs/heads/main}} \\
    \begin{pspicture}(2in,0.6in)
      \psbarcode[file]{.git/refs/heads/main}{}{pdf417}
    \end{pspicture}
    \vfill
    \includegraphics[width=4cm]{assets/by-nc-sa.png}\par
    \textcopyright 2022 Hans Wan \& Windy Deng\par
    本作品采用「知识共享\ 署名-非商业性使用-相同方式共享 4.0 国际」许可协议进行许可。
    要查看该许可协议，可访问 \url{http://creativecommons.org/licenses/by-nc-sa/4.0/}
    或者写信到 Creative Commons, PO Box 1866, Mountain View, CA 94042, USA。\par
    为便于进行教学，文中引用了一些来自互联网公开资源的图片及其他非我们原创的内容。
    这些内容的著作权归属它们的原作者和 / 或版权所有方所有。
    若有侵权请联系我们删除。
    我们对这些内容的作者表示感谢。\par
    文中出现的所有商标，无论是否标注有 ® 或 ™，其所有权都归属它们各自的持有者所有。\par
    \vspace{2ex}
    \small
    Segoe Fluent Icons, Office Support MDL2 Assets \textcopyright Microsoft Corporation. All Rights Reserved.\par
    \clearpage
    \setlength{\parskip}{0pt plus 1pt}
    \setlength{\parindent}{2em}
  \end{titlepage}
}%

% 自定义盒子
\newtcolorbox{note}{
  enhanced,
  frame hidden,
  breakable=true,
  arc=0mm,
  detach title,
  borderline west={.5mm}{0mm}{RoyalBlue4},
  colback=white,
  colbacktitle=RoyalBlue4,
  colframe=RoyalBlue4
}

% 练习
\newcommand{\practice}{\section*{练习 \thechapter}\addcontentsline{toc}{section}{练习 \thechapter}}